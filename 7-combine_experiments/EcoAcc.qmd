---
title: "EcoAcc: Long-term experimental data"
author: "Kara Dobson"
date: "`r format(Sys.time(), '%d %B, %Y')`"
format: 
  html:
    code-fold: true
    code-line-numbers: true
    code-tools:
      source: false
    toc: true
embed-resources: true
dpi: 300
editor: visual
editor_options: 
  chunk_output_type: console
---

```{r, echo = F, message = F, warning = F}
# Load packages
library(tidyverse)
library(ggpubr)
library(deeptime)
library(patchwork)
library(plotly)
library(maps)
library(mapdata)
library(gridExtra)
library(viridis)

# Set path to turbo to get plot data
path_data = "/Volumes/seas-zhukai/proj-ecoacc/data_for_plots/"
setwd(path_data)
# Load in data
map <- readRDS(" map.rds")

cti <- readRDS(" cti.rds")
biocon_cti <- readRDS(" biocon_cti.rds")
temperature_and_cti <- readRDS(" temperature_and_cti.rds")
biomass_and_cti <- readRDS(" biomass_and_cti.rds")
biomass_vs_cti <- readRDS(" biomass_vs_cti.rds")
biomass_vs_cti_treatments <- readRDS(" biomass_vs_cti_treatments.rds")
treatment_arrows <- readRDS(" treatment_arrows.rds")

point_center_cfc <- readRDS(" point_center_cfc.rds")
point_center_hwrc <- readRDS(" point_center_hwrc.rds")
point_center_tera <- readRDS(" point_center_tera.rds")
point_center_jrgce <- readRDS(" point_center_jrgce.rds")
point_center_ok <- readRDS(" point_center_ok.rds")
point_center_phace <- readRDS(" point_center_phace.rds")

point_ellipse_cfc <- readRDS(" point_ellipse_cfc.rds")
point_ellipse_hwrc <- readRDS(" point_ellipse_hwrc.rds")
point_ellipse_tera <- readRDS(" point_ellipse_tera.rds")
point_ellipse_jrgce <- readRDS(" point_ellipse_jrgce.rds")
point_ellipse_ok <- readRDS(" point_ellipse_ok.rds")
point_ellipse_phace <- readRDS(" point_ellipse_phace.rds")

point_plotly_cfc <- readRDS(" point_plotly_cfc.rds")
point_plotly_hwrc <- readRDS(" point_plotly_hwrc.rds")
point_plotly_tera <- readRDS(" point_plotly_tera.rds")
point_plotly_jrgce <- readRDS(" point_plotly_jrgce.rds")
point_plotly_ok <- readRDS(" point_plotly_ok.rds")
point_plotly_phace <- readRDS(" point_plotly_phace.rds")

scatter_cfc <- readRDS(" scatter_cfc.rds")
scatter_hwrc <- readRDS(" scatter_hwrc.rds")
scatter_jrgce <- readRDS(" scatter_jrgce.rds")
scatter_ok <- readRDS(" scatter_ok.rds")
scatter_phace <- readRDS(" scatter_phace.rds")
scatter_tera <- readRDS(" scatter_tera.rds")

# Set path to turbo to get TRY data
path_data = "/Volumes/seas-zhukai/proj-ecoacc/TRY_data/"
setwd(path_data)
# Load in data
traits <- read.csv(" exp_species_traits.csv")

# Set path to turbo to get teracon & biocon data
path_data = "/Volumes/seas-zhukai/proj-ecoacc/TeRaCON/"
setwd(path_data)
# Load in data
CTI_sens_teracon <- read.csv(" CTI_sens_teracon.csv")
CTI_teracon <- read.csv(" CTI_teracon.csv")
tera <- read.csv(" teracon_clean.csv")
NPP_teracon <- read.csv(" eco_response_teracon.csv")
NPP_overall_teracon <- read.csv(" eco_response_overall_teracon.csv")
CTI_CPI_teracon <- read.csv(" CTI_CPI_teracon.csv")
niche_est_tera <- read.csv(" teracon_niche.csv")
biocon <- read.csv(" CTI_biocon.csv")

# Set path to jrgce data
path_data = "/Volumes/seas-zhukai/proj-ecoacc/JRGCE/"
setwd(path_data)
# Load in data
CTI_sens_jrgce <- read.csv(" CTI_sens_jrgce.csv")
CTI_jrgce <- read.csv(" CTI_jrgce.csv")
jrgce <- read.csv(" jrgce_clean.csv")
NPP_jrgce <- read.csv(" eco_response_jrgce.csv")
NPP_overall_jrgce <- read.csv(" eco_response_overall_jrgce.csv")
CTI_CPI_jrgce <- read.csv(" CTI_CPI_jrgce.csv")
niche_est_jrgce <- read.csv(" jrgce_niche.csv")

# Set path to phace data
path_data = "/Volumes/seas-zhukai/proj-ecoacc/PHACE/"
setwd(path_data)
# Load in data
CTI_sens_phace <- read.csv(" CTI_sens_phace.csv")
CTI_phace <- read.csv(" CTI_phace.csv")
phace <- read.csv(" phace_clean.csv")
NPP_phace <- read.csv(" eco_response_phace.csv")
NPP_overall_phace <- read.csv(" eco_response_overall_phace.csv")
CTI_CPI_phace <- read.csv(" CTI_CPI_phace.csv")
niche_est_phace <- read.csv(" phace_niche.csv")

# Set path to b4warmed data
path_data = "/Volumes/seas-zhukai/proj-ecoacc/B4Warmed/"
setwd(path_data)
# Load in data
CTI_sens_b4_cfc <- read.csv(" CTI_sens_b4warmed_cfc.csv")
CTI_b4_cfc <- read.csv(" CTI_b4warmed_cfc.csv")
b4_cfc <- read.csv(" b4warmed_cfc_clean.csv")
NPP_b4_cfc <- read.csv(" eco_response_b4warmed_cfc.csv")
NPP_overall_b4_cfc <- read.csv(" eco_response_overall_b4warmed_cfc.csv")
CTI_CPI_b4_cfc <- read.csv(" CTI_CPI_b4warmed_cfc.csv")
niche_est_b4_cfc <- read.csv(" b4warmed_cfc_niche.csv")
CTI_sens_b4_hwrc <- read.csv(" CTI_sens_b4warmed_hwrc.csv")
CTI_b4_hwrc <- read.csv(" CTI_b4warmed_hwrc.csv")
b4_hwrc <- read.csv(" b4warmed_hwrc_clean.csv")
NPP_b4_hwrc <- read.csv(" eco_response_b4warmed_hwrc.csv")
NPP_overall_b4_hwrc <- read.csv(" eco_response_overall_b4warmed_hwrc.csv")
CTI_CPI_b4_hwrc <- read.csv(" CTI_CPI_b4warmed_hwrc.csv")
niche_est_b4_hwrc <- read.csv(" b4warmed_hwrc_niche.csv")

# Set path to oklahoma data
path_data = "/Volumes/seas-zhukai/proj-ecoacc/OK/"
setwd(path_data)
# Load in data
CTI_sens_ok <- read.csv(" CTI_sens_ok.csv")
CTI_ok <- read.csv(" CTI_ok.csv")
ok <- read.csv(" ok_clean.csv")
NPP_ok <- read.csv(" eco_response_ok.csv")
NPP_overall_ok <- read.csv(" eco_response_overall_ok.csv")
CTI_CPI_ok <- read.csv(" CTI_CPI_ok.csv")
niche_est_ok <- read.csv(" ok_niche.csv")
```

Using community composition and ecosystem response data from various warming experiments, we can visualize changes in community structure (e.g., CTI) alongside changes in function (e.g., ANPP) due to warming.

The experimental warming data set currently contains 6 sites across the U.S., shown below. These sites differ in terms of the length of the warming experiment, the amount warmed, and the species types present. However, all experiments contain a measurement of community composition and aboveground biomass for each year.

Community composition data: JRGCE and TeRaCON = percent cover, Oklahoma = relative abundance (using percent cover?), PHACE = relative abundance (using biomass data), B4Warmed = relative abundance (using current year's stem biomass)

## Map of the locations of each warming experiment

```{r, message = F, warning = F,fig.width = 10, fig.height = 6}
map
```

## CTI and NPP

### Changes in CTI over time between warmed and ambient treatments from 6 in situ warming experiments

CTI = community temperature index; a higher CTI means the community is "warmer", i.e., has a greater prevalence of warm-loving species. Similarly, CPI = community precipitation index, wherein a higher CPI means the community contains a greater prevalence of wet-loving species.

For these 6 experiments, we see an effect of the warming treatment on CTI, in which the warmed communities contain higher CTI than the ambient communities. The temporal trend is fuzzier, but these experiments are all relatively short-term.

```{r,message = F, warning = F, fig.width = 10, fig.height = 6}
cti
```

### Long-term TeRaCON plots

The plots labelled as 'warmed' had inherently higher CTI than the ambient plots prior to the initiation of warming in 2012

```{r,message = F, warning = F, fig.width = 8, fig.height = 5}
biocon_cti
```

### CTI over time w/ yearly ambient temperatures

Ambient temperatures are noted with the dotted lines. Note that at JRGCE, the ambient temperature data was scaled my multiplying by 1.5, whereas at TeRaCON, the data was scaled by dividing by 2.1. Therefore, ambient temperatures at JRGCE are lower than the CTI values, whereas ambient temperatures are higher than CTI values at TeRaCON.

```{r,message = F, warning = F, fig.width = 10, fig.height = 6}
temperature_and_cti
```

### The effect of warming (warmed - ambient) on CTI and NPP over time

```{r,message = F, warning = F, fig.width = 6, fig.height = 9}
biomass_and_cti
```

### Relationship between CTI and aboveground biomass production each year

```{r, message = F, warning = F, fig.width = 14, fig.height = 6}
biomass_vs_cti
```

### Relationship between CTI and aboveground biomass between climate treatments

```{r, message = F, warning = F, fig.width = 14, fig.height = 6}
biomass_vs_cti_treatments
```

## Treatment arrows

### Each arrow represents one year. The arrow points in the direction of the treatment effect (ambient –\> warmed) and is colored by the year (yellow = most recent)

For example, CTI of PHACE declined over time, but the warmed treatment increased CTI over time when compared to the ambient treatment. On the contrary, B4Warmed doesn't show a strong temporal trend, but the treatment effect shows the majority of years with higher CTI and CPI under warmed conditions.

```{r, warning=F,message=F, fig.width = 14, fig.height = 7}
treatment_arrows
```

## Species-level analyses

### Species contributions to CTI

Which species contribute most to the change in CTI over time? The dotted line represents the overall slope of CTI over time (for PHACE, CTI declined over time), whereas the points represent the contribution of each species to that change in CTI. The species contribution = the slope of that species' abundance over time \* the species' temperature index

```{r,message=F,warning=F,fig.width = 14, fig.height = 8}
ggarrange(point_center_phace,point_ellipse_phace,
          widths = c(1.5,0.75))
ggarrange(point_center_jrgce,point_ellipse_jrgce,
          widths = c(1.5,0.75))
ggarrange(point_center_tera,point_ellipse_tera,
          widths = c(1.5,0.75))
ggarrange(point_center_ok,point_ellipse_ok,
          widths = c(1.5,0.75))
ggarrange(point_center_cfc,point_ellipse_cfc,
          widths = c(1.5,0.75))
ggarrange(point_center_hwrc,point_ellipse_hwrc,
          widths = c(1.5,0.75))
```

### (TBD) Species contributing to warming effect

The above figure demonstrates species that contributed to the CTI decline over time, but what about the effect of warming? Here, I quantified the warming effect on CTI (warmed CTI - ambient CTI) for each year, then performed the contribution analysis to determine which species contributed to the increasing warming effect on CTI over time

```{r,message=F,warning=F,fig.width = 13, fig.height = 6}
#ggarrange(phace_scatter2,point,
#          widths = c(0.5,1.5))
```

## Plant traits

### Plant trait values as a function of the species' thermal niche (Trait data from TRY)

```{r,warning=F,message=F,fig.width = 13, fig.height = 6}
##### Fig: traits vs. temp niche
# make a dataframe containing all species and their temp niches
tera_niche_filt <- niche_est_tera %>%
  dplyr::select(species,temp_niche) %>%
  distinct()
jrgce_niche_filt <- niche_est_jrgce %>%
  dplyr::select(species,temp_niche) %>%
  distinct()
phace_niche_filt <- niche_est_phace %>%
  dplyr::select(species,temp_niche) %>%
  distinct()
b4_cfc_niche_filt <- niche_est_b4_cfc %>%
  dplyr::select(species,temp_niche) %>%
  distinct()
b4_hwrc_niche_filt <- niche_est_b4_hwrc %>%
  dplyr::select(species,temp_niche) %>%
  distinct()
ok_niche_filt <- niche_est_ok %>%
  dplyr::select(species,temp_niche) %>%
  distinct()

# Combine all species and temp niches into one dataframe
all_niche <- rbind(tera_niche_filt,jrgce_niche_filt,phace_niche_filt,b4_cfc_niche_filt,b4_hwrc_niche_filt,ok_niche_filt)

# Renaming species to match the names found in Try
all_niche$species[all_niche$species == "Agropyron repens"] <- "Elymus repens"
all_niche$species[all_niche$species == "Lysimachia arvensis"] <- "Anagallis arvensis"
all_niche$species[all_niche$species == "Stipa pulchra"] <- "Nassella pulchra"
all_niche$species[all_niche$species == "Andropogon gerardi"] <- "Andropogon gerardii"
all_niche$species[all_niche$species == "Koeleria cristata"] <- "Koeleria macrantha"
all_niche$species[all_niche$species == "Festuca perennis"] <- "Lolium perenne"
all_niche$species[all_niche$species == "Taraxia ovata"] <- "Camissonia ovata"
all_niche$species[all_niche$species == "Festuca bromoides"] <- "Vulpia bromoides"
all_niche$species[all_niche$species == "Logfia gallica"] <- "Filago gallica"
all_niche$species[all_niche$species == "Pascopyrum smithii"] <- "Elymus smithii"
all_niche$species[all_niche$species == "Hesperostipa comata"] <- "Stipa comata"   
all_niche$species[all_niche$species == "Picradeniopsis oppositifolia"] <- "Bahia oppositifolia"
all_niche$species[all_niche$species == "Heterotheca villosa"] <- "Chrysopsis villosa"
all_niche$species[all_niche$species == "Cryptantha thyrsiflora"] <- "Oreocarya thyrsiflora"
all_niche$species[all_niche$species == "Cryptantha cinerea"] <- "Oreocarya suffruticosa"
all_niche$species[all_niche$species == "Draba reptans"] <- "Tomostima reptans"
all_niche$species[all_niche$species == "Machaeranthera pinnatifida"] <- "Xanthisma spinulosum"
all_niche$species[all_niche$species == "Lesquerella montana"] <- "Physaria montana"
all_niche$species[all_niche$species == "Machaeranthera canescens"] <- "Dieteria canescens"
all_niche$species[all_niche$species == "Salsola tragus"] <- "Kali tragus"
all_niche$species[all_niche$species == "Populus tremouloides"] <- "Populus tremuloides"
all_niche$species[all_niche$species == "Calylophus serrulatus"] <- "Oenothera serrulata"
all_niche$species[all_niche$species == "Coreopsis grandiflora"] <- "Bidens sweetiana"
all_niche$species[all_niche$species == "Dichanthelium oligosanthes"] <- "Panicum oligosanthes"
all_niche$species[all_niche$species == "Gaura parviflora"] <- "Oenothera curtiflora"
all_niche$species[all_niche$species == "Hedyotis nigricans"] <- "Stenaria nigricans"
all_niche$species[all_niche$species == "Psoralidium tenuiflorum"] <- "Pediomelum tenuiflorum"
all_niche$species[all_niche$species == "Solidago ludiviciana"] <- "Solidago ludoviciana"
all_niche$species[all_niche$species == "Stenosiphon linifolius"] <- "Oenothera glaucifolia"
all_niche$species[all_niche$species == "Symphyotrichum ericoides "] <- "Symphyotrichum ericoides"
all_niche$species[all_niche$species == "Amphiachyris dracunculoides"] <- "Gutierrezia dracunculoides"
all_niche$species[all_niche$species == "Diodia teres"] <- "Hexasepalum teres"
all_niche$species[all_niche$species == "Stipa tenuissima"] <- "Nassella tenuissima"
all_niche$species[all_niche$species == "Rubus calycinoides"] <- "Rubus rolfei"
all_niche$species[all_niche$species == "Rubus pentalobus"] <- "Rubus rolfei"
all_niche$species[all_niche$species == "Ruellia hirta"] <- "Strobilanthes glutinosus"
all_niche$species[all_niche$species == "solidago drummondii"] <- "Solidago drummondii"
all_niche$species[all_niche$species == "Symphyotrichum ontarionsis"] <- "Symphyotrichum ontarionis"
all_niche$species[all_niche$species == "Haplopappus ciliatus"] <- "Grindelia ciliata"
all_niche$species[all_niche$species == "Heterotheca latifolia"] <- "Heterotheca subaxillaris"
all_niche$species[all_niche$species == "Muhlenbergia capillaris "] <- "Muhlenbergia capillaris"
all_niche$species[all_niche$species == "Setaria glauca"] <- "Pennisetum glaucum"
all_niche$species[all_niche$species == "Ambrosia trida"] <- "Ambrosia trifida"
all_niche$species[all_niche$species == "Diodia ocymifolia"] <- "Spermacoce ocymifolia"
all_niche$species[all_niche$species == "Grindelia papposa"] <- "Grindelia ciliata"
all_niche$species[all_niche$species == "Tragia cannabina"] <- "Tragia plukenetii"
all_niche$species[all_niche$species == "Trifolium purpureum "] <- "Trifolium purpureum"
all_niche$species[all_niche$species == "Melilotus alba"] <- "Trigonella alba"
all_niche$species[all_niche$species == "Coreopsis tinctoria"] <- "Bidens tinctoria"

# Combine all species niche data with trait data
# rename AccSpeciesName column in traits dataframe
colnames(traits)[1] <- "species"
traits_niche <- left_join(all_niche,traits, by="species")
traits_niche <- traits_niche %>%
  filter(!is.na(TraitID))

# Fixing long trait names
traits_niche$TraitName[traits_niche$TraitName == "Leaf dry mass per leaf fresh mass (leaf dry matter content, LDMC)"] <- "LDMC"
traits_niche$TraitName[traits_niche$TraitName == "Fine root length per fine root dry mass (specific fine root length, SRL)"] <- "Specific fine root length"
traits_niche$TraitName[traits_niche$TraitName == "Root length per root dry mass (specific root length, SRL)"] <- "Specific root length"
traits_niche$TraitName[traits_niche$TraitName == "Plant biomass and allometry: Fine root length per plant"] <- "Fine root length"
traits_niche$TraitName[traits_niche$TraitName == "Leaf area per leaf dry mass (specific leaf area, SLA or 1/LMA): undefined if petiole is in- or excluded"] <- "SLA"
traits_niche$TraitName[traits_niche$TraitName == "Coarse root length per coarse root dry mass (specific coarse root length, SRL)"] <- "Specific coarse root length"
traits_niche$TraitName[traits_niche$TraitName == "Plant biomass and allometry: Coarse root length per plant"] <- "Coarse root length"

# Removing some high outliers and traits with little data
traits_niche_rem <- traits_niche %>%
  filter(TraitName == "Plant height vegetative") %>%
  filter(mean_trait_val < 400)
traits_niche_rem2 <- traits_niche %>%
  filter(TraitName == "Specific fine root length") %>%
  filter(mean_trait_val < 8000)
rest_of_data <- traits_niche %>%
  filter(!(TraitName == "Plant height vegetative" |
             TraitName == "Specific fine root length"))
combined_data <- bind_rows(traits_niche_rem, traits_niche_rem2, rest_of_data)
combined_data <- combined_data %>%
  filter(!(TraitName == "Fine root length" |
             TraitName == "Coarse root length" |
             TraitName == "Specific coarse root length" |
             TraitName == "Dispersal syndrome")) %>%
  mutate(mean_trait_val_log = log(mean_trait_val))

# Make a function to select a given trait name and plot it against temp niche
trait_niche_plot <- function(data,trait){
  plot_data <- data %>%
    filter(TraitID == trait)
  
  trait_name <- plot_data$TraitName[1]
  
  ggplot(plot_data, aes(x = temp_niche, y = mean_trait_val_log)) +
    geom_point() +
    geom_smooth() +
    labs(title = trait_name, x = "Temperature niche (°C)", y = "Log(trait value)") +
    theme_minimal()
}
#trait_niche_plot(traits_niche_rem,3106)

# Initialize a list to store plots
plots_list <- list()

# Check unique TraitID values
unique_trait_ids <- unique(combined_data$TraitID)

# Generate plots and store them in the list
for (trait in unique_trait_ids) {
  # Ensure `trait` is always a single entity
  if (length(trait) == 1) {
    # Assuming trait_niche_plot returns a plot
    p <- trait_niche_plot(combined_data, trait)
    plots_list[[as.character(trait)]] <- p  # Convert to character to avoid unintended issues with numeric indices
  } else {
    message("Warning: Encountered unexpected multi-length trait identifier.")
  }
}

# Arrange all plots in a grid
grid.arrange(grobs = plots_list)
```

### An interactive plot that shows the species name for the niche x trait value plot

```{r,warning=F,message=F}
# Interactive plot
combined_data_plotly <- combined_data %>%
  filter(TraitName == "Leaf thickness")
plot_ly(data=combined_data_plotly, x = ~temp_niche, y = ~mean_trait_val_log,
        type="scatter",mode="markers",color=~species)

# Generate a list of all unique trait names
trait_names <- unique(combined_data$TraitName)

# Create a master plot without specific initial data
p <- plot_ly(type = 'scatter', mode = 'markers')

# Add a trace for each (trait, species) combination
for (i in seq_along(trait_names)) {
  trait_data <- combined_data[combined_data$TraitName == trait_names[i], ]
  species_names <- unique(trait_data$species)
  
  for (species in species_names) {
    species_data <- trait_data[trait_data$species == species, ]
    
    p <- add_trace(p,
                   data = species_data,
                   x = ~temp_niche,
                   y = ~mean_trait_val,
                   name = species,
                   text = ~paste("Species:", species),  # Custom hover text
                   hoverinfo = "text",  # Ensure that only custom text is displayed
                   colors = "Dark2",
                   visible = i == 1  # Show only the first trait initially
    )
  }
}

# Add the dropdown to switch visibility between traces
p <- layout(p,
            updatemenus = list(
              list(
                type = 'dropdown',
                active = 0,  # Initial active trait (0-indexed)
                buttons = lapply(seq_along(trait_names), function(i) {
                  list(
                    label = trait_names[i],
                    method = "update",
                    args = list(
                      list(visible = as.logical(rep(seq_along(trait_names) == i, each = length(species_names)))),
                      list(title = paste("Mean Trait Value for", trait_names[i]))  # Update the plot title based on the selected trait
                    )
                  )
                })
              )
            ),
            xaxis = list(title = "Temperature Niche"),
            yaxis = list(title = "Mean Trait Value")
)

p
```
