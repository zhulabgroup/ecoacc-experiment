---
title: "EcoAcc: Long-term experimental data"
author: "Kara Dobson"
date: "`r format(Sys.time(), '%d %B, %Y')`"
format: 
  html:
    code-fold: true
    code-line-numbers: true
    code-tools:
      source: false
    toc: true
embed-resources: true
dpi: 300
editor: visual
editor_options: 
  chunk_output_type: console
---

```{r, echo = F, message = F, warning = F}
# Load packages
library(tidyverse)
library(ggpubr)
library(deeptime)
library(patchwork)
library(plotly)
library(maps)
library(mapdata)
library(gridExtra)
library(viridis)

# Set path to turbo to get plot data
path_data = "/Volumes/seas-zhukai/proj-ecoacc-experiment/data_for_plots/"
setwd(path_data)
# Load in data
map <- readRDS(" map.rds")

cti <- readRDS(" cti.rds")
sens <- readRDS(" sens.rds")
cti_sens <- readRDS(" cti_sens.rds")
biocon_cti <- readRDS(" biocon_cti.rds")
temperature_and_cti <- readRDS(" temperature_and_cti.rds")
biomass_and_cti <- readRDS(" biomass_and_cti.rds")
biomass_vs_cti <- readRDS(" biomass_vs_cti.rds")
biomass_vs_cti_treatments <- readRDS(" biomass_vs_cti_treatments.rds")
biomass_vs_dis <- readRDS(" biomass_vs_disequilib.rds")
treatment_arrows <- readRDS(" treatment_arrows.rds")

point_center_cfc <- readRDS(" point_center_cfc.rds")
point_center_hwrc <- readRDS(" point_center_hwrc.rds")
point_center_tera <- readRDS(" point_center_tera.rds")
point_center_jrgce <- readRDS(" point_center_jrgce.rds")
point_center_ok <- readRDS(" point_center_ok.rds")
point_center_phace <- readRDS(" point_center_phace.rds")

point_center_treat_cfc <- readRDS(" point_center_treat_cfc.rds")
point_center_treat_hwrc <- readRDS(" point_center_treat_hwrc.rds")
point_center_treat_tera <- readRDS(" point_center_treat_tera.rds")
point_center_treat_jrgce <- readRDS(" point_center_treat_jrgce.rds")
point_center_treat_ok <- readRDS(" point_center_treat_ok.rds")
point_center_treat_phace <- readRDS(" point_center_treat_phace.rds")

point_ellipse_cfc <- readRDS(" point_ellipse_cfc.rds")
point_ellipse_hwrc <- readRDS(" point_ellipse_hwrc.rds")
point_ellipse_tera <- readRDS(" point_ellipse_tera.rds")
point_ellipse_jrgce <- readRDS(" point_ellipse_jrgce.rds")
point_ellipse_ok <- readRDS(" point_ellipse_ok.rds")
point_ellipse_phace <- readRDS(" point_ellipse_phace.rds")

point_ellipse_treat_cfc <- readRDS(" point_ellipse_treat_cfc.rds")
point_ellipse_treat_hwrc <- readRDS(" point_ellipse_treat_hwrc.rds")
point_ellipse_treat_tera <- readRDS(" point_ellipse_treat_tera.rds")
point_ellipse_treat_jrgce <- readRDS(" point_ellipse_treat_jrgce.rds")
point_ellipse_treat_ok <- readRDS(" point_ellipse_treat_ok.rds")
point_ellipse_treat_phace <- readRDS(" point_ellipse_treat_phace.rds")

point_contours_treat_cfc <- readRDS(" point_contours_treat_cfc.rds")
point_contours_treat_hwrc <- readRDS(" point_contours_treat_hwrc.rds")
point_contours_treat_tera <- readRDS(" point_contours_treat_tera.rds")
point_contours_treat_jrgce <- readRDS(" point_contours_treat_jrgce.rds")
point_contours_treat_ok <- readRDS(" point_contours_treat_ok.rds")
point_contours_treat_phace <- readRDS(" point_contours_treat_phace.rds")

point_contours_treat_all <- readRDS(" point_contours_treat_all.rds")
point_contours_treat_vals_all <- readRDS(" point_contours_treat_vals_all.rds")
point_contours_all_sites <- readRDS(" all_sites_contour.rds")

point_plotly_cfc <- readRDS(" point_plotly_cfc.rds")
point_plotly_hwrc <- readRDS(" point_plotly_hwrc.rds")
point_plotly_tera <- readRDS(" point_plotly_tera.rds")
point_plotly_jrgce <- readRDS(" point_plotly_jrgce.rds")
point_plotly_ok <- readRDS(" point_plotly_ok.rds")
point_plotly_phace <- readRDS(" point_plotly_phace.rds")

scatter_cfc <- readRDS(" scatter_cfc.rds")
scatter_hwrc <- readRDS(" scatter_hwrc.rds")
scatter_jrgce <- readRDS(" scatter_jrgce.rds")
scatter_ok <- readRDS(" scatter_ok.rds")
scatter_phace <- readRDS(" scatter_phace.rds")
scatter_tera <- readRDS(" scatter_tera.rds")

scatter_treat_cfc <- readRDS(" scatter_treat_cfc.rds")
scatter_treat_hwrc <- readRDS(" scatter_treat_hwrc.rds")
scatter_treat_jrgce <- readRDS(" scatter_treat_jrgce.rds")
scatter_treat_ok <- readRDS(" scatter_treat_ok.rds")
scatter_treat_phace <- readRDS(" scatter_treat_phace.rds")
scatter_treat_tera <- readRDS(" scatter_treat_tera.rds")

biocon_pre <- readRDS(" biocon_treat_pre.rds")
biocon_post <- readRDS(" biocon_treat_post.rds")

phylo_phace <- readRDS(" phylo_plot_phace.rds")
phylo_all <- readRDS(" phylo_plot_all.rds")
phylo_all_circ <- readRDS(" phylo_plot_all_circ.rds")
```

Using community composition and ecosystem response data from various warming experiments, we can visualize changes in community structure (e.g., CTI) alongside changes in function (e.g., ANPP) due to warming.

The experimental warming data set currently contains 6 sites across the U.S., shown below. These sites differ in terms of the length of the warming experiment, the amount warmed, and the species types present. However, all experiments contain a measurement of community composition and aboveground biomass for each year.

## Map of the locations of each warming experiment

```{r, message = F, warning = F,fig.width = 10, fig.height = 6}
map
```

## CTI and NPP

### Changes in CTI over time between warmed and ambient treatments from 6 in situ warming experiments

```{r,message = F, warning = F, fig.width = 10, fig.height = 7}
sens
```

### Relationship between CTI and aboveground biomass production each year

```{r, message = F, warning = F, fig.width = 14, fig.height = 6}
biomass_vs_cti
```

### Relationship between climate-community disequilibrium and aboveground biomass production each year

MAT - CTI represents community-climate disequilibrium. MAT data were calculated by obtaining yearly ambient MAT data from weather stations near each site (using IEM stations), then offsetting the MAT by the amount warmed by the warming treatment. IEM was used rather than Terra/WorldClim because the latter goes until 2019 only.

We see warmed treatments on the left because the MAT under warming is greater than MAT under ambient conditions. Therefore, although we see warming increasing CTI, the CTI isn't yet matching the elevated MAT.

```{r, message = F, warning = F, fig.width = 13, fig.height = 6}
biomass_vs_dis
```

## Treatment arrows

### Each arrow represents one year. The arrow points in the direction of the treatment effect (ambient â€“\> warmed) and is colored by the year (yellow = most recent)

For example, CTI of PHACE declined over time, but the warmed treatment increased CTI over time when compared to the ambient treatment. On the contrary, B4Warmed doesn't show a strong temporal trend, but the treatment effect shows the majority of years with higher CTI and CPI under warmed conditions.

```{r, warning=F,message=F, fig.width = 14, fig.height = 7}
treatment_arrows
```

## Species-level analyses

### Species contributing to warming effect

```{r,message=F,warning=F,fig.width = 17, fig.height = 14}
point_contours_all_sites
```

### Species contributing to warming effect (site-specific)

Here, I quantified the warming effect on CTI (warmed CTI - ambient CTI) for each year, then performed the contribution analysis to determine which species contributed to the warming effect on CTI over time. The dotted line represents the overall slope of the warming effect on CTI over time (e.g. increasing slope = the warmed treatment increased CTI relative to ambient over time), whereas the points represent the contribution of each species to that change. The species contribution = the slope of the warming effect on that species' abundance over time (warmed abun - ambient abun for each year) \* the species' temperature index.

```{r,message=F,warning=F,fig.width = 15, fig.height = 8}
ggarrange(point_center_treat_phace,
          ggarrange(point_ellipse_treat_phace, point_contours_treat_phace, nrow = 2),
          ncol = 2) 
ggarrange(point_center_treat_jrgce,
          ggarrange(point_ellipse_treat_jrgce, point_contours_treat_jrgce, nrow = 2),
          ncol = 2) 
ggarrange(point_center_treat_tera,
          ggarrange(point_ellipse_treat_tera, point_contours_treat_tera, nrow = 2),
          ncol = 2) 
ggarrange(point_center_treat_ok,
          ggarrange(point_ellipse_treat_ok, point_contours_treat_ok, nrow = 2),
          ncol = 2) 
ggarrange(point_center_treat_cfc,
          ggarrange(point_ellipse_treat_cfc, point_contours_treat_cfc, nrow = 2),
          ncol = 2) 
ggarrange(point_center_treat_hwrc,
          ggarrange(point_ellipse_treat_hwrc, point_contours_treat_hwrc, nrow = 2),
          ncol = 2) 
```

### Mapping species contributions to phylogeny

Red species have greater relative contributions to CTI than blue species. If a species was present in more than one experiment, the contribution value shown here is an average of its relative contribution.

```{r,message=F,warning=F,fig.width = 20, fig.height = 20}
phylo_all_circ
```
